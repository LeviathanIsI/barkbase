name: Visual Regression Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/src/**'
      - 'frontend/e2e/tests/visual/**'
      - '.github/workflows/visual-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/src/**'
      - 'frontend/e2e/tests/visual/**'
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Update visual baselines'
        required: false
        default: false
        type: boolean

env:
  CI: true
  BASE_URL: http://localhost:5173
  E2E_ADMIN_EMAIL: ${{ secrets.E2E_ADMIN_EMAIL }}
  E2E_ADMIN_PASSWORD: ${{ secrets.E2E_ADMIN_PASSWORD }}

jobs:
  visual-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for baseline comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Build application
        working-directory: frontend
        run: npm run build

      - name: Run Visual Tests
        working-directory: frontend
        run: |
          if [ "${{ github.event.inputs.update_snapshots }}" == "true" ]; then
            npx playwright test e2e/tests/visual --project=chromium --update-snapshots
          else
            npx playwright test e2e/tests/visual --project=chromium
          fi
        env:
          E2E_ADMIN_EMAIL: ${{ secrets.E2E_ADMIN_EMAIL }}
          E2E_ADMIN_PASSWORD: ${{ secrets.E2E_ADMIN_PASSWORD }}

      - name: Upload Visual Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-report
          path: |
            frontend/e2e/reports/
            frontend/e2e/test-results/
          retention-days: 30

      - name: Upload Visual Baselines
        uses: actions/upload-artifact@v4
        if: github.event.inputs.update_snapshots == 'true'
        with:
          name: visual-baselines
          path: frontend/e2e/visual-baselines/
          retention-days: 90

      - name: Upload Screenshot Diffs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshot-diffs
          path: |
            frontend/e2e/test-results/**/*-diff.png
            frontend/e2e/test-results/**/*-actual.png
          retention-days: 14

      - name: Comment on PR with Visual Diff
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find diff images
            const testResultsDir = 'frontend/e2e/test-results';
            let diffFiles = [];

            function findDiffs(dir) {
              if (!fs.existsSync(dir)) return;
              const files = fs.readdirSync(dir);
              for (const file of files) {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                if (stat.isDirectory()) {
                  findDiffs(filePath);
                } else if (file.includes('-diff.png')) {
                  diffFiles.push(filePath);
                }
              }
            }

            findDiffs(testResultsDir);

            let comment = '## Visual Regression Test Results\n\n';
            comment += '❌ **Visual differences detected!**\n\n';

            if (diffFiles.length > 0) {
              comment += `Found ${diffFiles.length} visual difference(s):\n\n`;
              for (const diff of diffFiles.slice(0, 10)) {
                comment += `- \`${path.basename(diff)}\`\n`;
              }
              if (diffFiles.length > 10) {
                comment += `\n...and ${diffFiles.length - 10} more\n`;
              }
            }

            comment += '\n### Next Steps\n';
            comment += '1. Download the `screenshot-diffs` artifact to review changes\n';
            comment += '2. If changes are intentional, run the workflow with "Update visual baselines" enabled\n';
            comment += '3. Commit the updated baselines to this PR\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  visual-responsive:
    name: Responsive Visual Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: visual-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Build application
        working-directory: frontend
        run: npm run build

      - name: Run Responsive Visual Tests
        working-directory: frontend
        run: npx playwright test e2e/tests/visual/responsive.visual.spec.js --project=chromium
        env:
          E2E_ADMIN_EMAIL: ${{ secrets.E2E_ADMIN_EMAIL }}
          E2E_ADMIN_PASSWORD: ${{ secrets.E2E_ADMIN_PASSWORD }}

      - name: Upload Responsive Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: responsive-visual-report
          path: frontend/e2e/reports/
          retention-days: 30

  visual-accessibility:
    name: Accessibility Visual Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: visual-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Build application
        working-directory: frontend
        run: npm run build

      - name: Run Accessibility Visual Tests
        working-directory: frontend
        run: npx playwright test e2e/tests/visual/accessibility.visual.spec.js --project=chromium
        env:
          E2E_ADMIN_EMAIL: ${{ secrets.E2E_ADMIN_EMAIL }}
          E2E_ADMIN_PASSWORD: ${{ secrets.E2E_ADMIN_PASSWORD }}

      - name: Upload Accessibility Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-visual-report
          path: frontend/e2e/reports/
          retention-days: 30

  visual-summary:
    name: Visual Test Summary
    runs-on: ubuntu-latest
    needs: [visual-tests, visual-responsive, visual-accessibility]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Summary
        run: |
          echo "## Visual Regression Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Suites" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.visual-tests.result }}" == "success" ]; then
            echo "✅ Component Visual Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Component Visual Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.visual-responsive.result }}" == "success" ]; then
            echo "✅ Responsive Visual Tests: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.visual-responsive.result }}" == "skipped" ]; then
            echo "⏭️ Responsive Visual Tests: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Responsive Visual Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.visual-accessibility.result }}" == "success" ]; then
            echo "✅ Accessibility Visual Tests: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.visual-accessibility.result }}" == "skipped" ]; then
            echo "⏭️ Accessibility Visual Tests: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Accessibility Visual Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Visual test reports are available as workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshot diffs are available when tests fail" >> $GITHUB_STEP_SUMMARY
