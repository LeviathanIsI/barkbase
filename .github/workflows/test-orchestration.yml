name: Test Orchestration Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/src/**'
      - 'frontend/e2e/**'
      - 'frontend/test-orchestration/**'
      - '.github/workflows/test-orchestration.yml'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      strategy:
        description: 'Test strategy'
        required: false
        default: 'full'
        type: choice
        options:
          - quick
          - standard
          - full
          - ci
      run_e2e:
        description: 'Run E2E tests'
        required: false
        default: true
        type: boolean
      run_visual:
        description: 'Run visual tests'
        required: false
        default: false
        type: boolean

env:
  CI: true
  NODE_ENV: test
  BASE_URL: http://localhost:5173

jobs:
  # Stage 1: Fast Tests (Unit tests - lib, stores, hooks)
  fast-tests:
    name: 'Stage 1: Fast Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      passed: ${{ steps.test.outputs.passed }}
      failed: ${{ steps.test.outputs.failed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run Fast Tests
        id: test
        working-directory: frontend
        run: |
          npm test -- --run \
            src/lib/__tests__/*.test.js \
            src/stores/__tests__/*.test.js \
            src/hooks/__tests__/*.test.js \
            --reporter=json --outputFile=test-results/fast-tests.json 2>&1 || true

          # Extract results
          if [ -f test-results/fast-tests.json ]; then
            PASSED=$(jq '.numPassedTests // 0' test-results/fast-tests.json)
            FAILED=$(jq '.numFailedTests // 0' test-results/fast-tests.json)
          else
            PASSED=0
            FAILED=1
          fi

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi

      - name: Upload Fast Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fast-test-results
          path: frontend/test-results/
          retention-days: 7

  # Stage 2: Component Tests
  component-tests:
    name: 'Stage 2: Component Tests'
    runs-on: ubuntu-latest
    needs: fast-tests
    timeout-minutes: 15

    outputs:
      passed: ${{ steps.test.outputs.passed }}
      failed: ${{ steps.test.outputs.failed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run Component Tests
        id: test
        working-directory: frontend
        run: |
          npm test -- --run \
            src/components/__tests__/**/*.test.jsx \
            src/components/**/__tests__/*.test.jsx \
            --reporter=json --outputFile=test-results/component-tests.json 2>&1 || true

          if [ -f test-results/component-tests.json ]; then
            PASSED=$(jq '.numPassedTests // 0' test-results/component-tests.json)
            FAILED=$(jq '.numFailedTests // 0' test-results/component-tests.json)
          else
            PASSED=0
            FAILED=0
          fi

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi

      - name: Upload Component Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: component-test-results
          path: frontend/test-results/
          retention-days: 7

  # Stage 3: Feature Tests
  feature-tests:
    name: 'Stage 3: Feature Tests'
    runs-on: ubuntu-latest
    needs: component-tests
    timeout-minutes: 20

    outputs:
      passed: ${{ steps.test.outputs.passed }}
      failed: ${{ steps.test.outputs.failed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run Feature Tests
        id: test
        working-directory: frontend
        run: |
          npm test -- --run \
            src/features/**/*.test.jsx \
            src/app/**/*.test.jsx \
            --reporter=json --outputFile=test-results/feature-tests.json 2>&1 || true

          if [ -f test-results/feature-tests.json ]; then
            PASSED=$(jq '.numPassedTests // 0' test-results/feature-tests.json)
            FAILED=$(jq '.numFailedTests // 0' test-results/feature-tests.json)
          else
            PASSED=0
            FAILED=0
          fi

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi

      - name: Upload Feature Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: feature-test-results
          path: frontend/test-results/
          retention-days: 7

  # Stage 4: Coverage Analysis
  coverage:
    name: 'Stage 4: Coverage Analysis'
    runs-on: ubuntu-latest
    needs: [fast-tests, component-tests, feature-tests]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run Tests with Coverage
        working-directory: frontend
        run: |
          npm test -- --run --coverage || true

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: frontend/coverage/
          retention-days: 30

      - name: Coverage Summary
        working-directory: frontend
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.total | to_entries | .[] | "| \(.key) | \(.value.pct)% |"' coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
          fi

  # Stage 5: E2E Tests (Conditional)
  e2e-tests:
    name: 'Stage 5: E2E Tests'
    runs-on: ubuntu-latest
    needs: [fast-tests, component-tests, feature-tests]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_e2e == 'true')
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Build Application
        working-directory: frontend
        run: npm run build

      - name: Run E2E Tests
        working-directory: frontend
        run: npx playwright test --project=chromium e2e/tests/*.spec.js
        env:
          E2E_ADMIN_EMAIL: ${{ secrets.E2E_ADMIN_EMAIL }}
          E2E_ADMIN_PASSWORD: ${{ secrets.E2E_ADMIN_PASSWORD }}

      - name: Upload E2E Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            frontend/e2e/reports/
            frontend/e2e/test-results/
          retention-days: 14

  # Stage 6: Visual Tests (Conditional)
  visual-tests:
    name: 'Stage 6: Visual Tests'
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_visual == 'true')
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Build Application
        working-directory: frontend
        run: npm run build

      - name: Run Visual Tests
        working-directory: frontend
        run: npx playwright test --project=chromium e2e/tests/visual/

      - name: Upload Visual Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-results
          path: |
            frontend/e2e/reports/
            frontend/e2e/visual-baselines/
          retention-days: 14

  # Final Summary
  summary:
    name: 'Pipeline Summary'
    runs-on: ubuntu-latest
    needs: [fast-tests, component-tests, feature-tests, coverage]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## Test Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stage Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Passed | Failed |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          # Fast Tests
          if [ "${{ needs.fast-tests.result }}" == "success" ]; then
            echo "| Fast Tests | ✅ | ${{ needs.fast-tests.outputs.passed }} | ${{ needs.fast-tests.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Fast Tests | ❌ | ${{ needs.fast-tests.outputs.passed }} | ${{ needs.fast-tests.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # Component Tests
          if [ "${{ needs.component-tests.result }}" == "success" ]; then
            echo "| Component Tests | ✅ | ${{ needs.component-tests.outputs.passed }} | ${{ needs.component-tests.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Component Tests | ❌ | ${{ needs.component-tests.outputs.passed }} | ${{ needs.component-tests.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # Feature Tests
          if [ "${{ needs.feature-tests.result }}" == "success" ]; then
            echo "| Feature Tests | ✅ | ${{ needs.feature-tests.outputs.passed }} | ${{ needs.feature-tests.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Feature Tests | ❌ | ${{ needs.feature-tests.outputs.passed }} | ${{ needs.feature-tests.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # Coverage
          if [ "${{ needs.coverage.result }}" == "success" ]; then
            echo "| Coverage | ✅ | - | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Coverage | ❌ | - | - |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overall Status" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.fast-tests.result }}" == "success" ] && \
             [ "${{ needs.component-tests.result }}" == "success" ] && \
             [ "${{ needs.feature-tests.result }}" == "success" ]; then
            echo "✅ **All tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
          fi
