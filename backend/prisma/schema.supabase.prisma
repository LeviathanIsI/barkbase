// This schema is designed to match the exact Supabase schema structure

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums matching Supabase exactly
enum TenantPlan {
  FREE
  PRO
  ENTERPRISE
}

enum Role {
  OWNER
  ADMIN
  STAFF
  READONLY
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  CHECKED_OUT
  COMPLETED
  CANCELLED
}

enum IncidentSeverity {
  MINOR
  MODERATE
  SEVERE
  CRITICAL
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  REFUNDED
  FAILED
}

enum ServiceCategory {
  BOARDING
  DAYCARE
  GROOMING
  TRAINING
  OTHER
}

enum KennelType {
  SUITE
  KENNEL
  CABIN
  DAYCARE
  MEDICAL
}

enum CommunicationType {
  EMAIL
  SMS
  CALL
  NOTE
  SYSTEM
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
  INTERNAL
}

enum NoteVisibility {
  ALL
  STAFF
  ADMIN
  PRIVATE
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum TaskType {
  FEEDING
  MEDICATION
  EXERCISE
  CLEANING
  HEALTH_CHECK
  SPECIAL_CARE
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Models matching Supabase tables exactly
model Tenant {
  recordId        String      @id @default(cuid())
  slug            String      @unique
  name            String
  themeJson       Json?
  featureFlags    Json?
  plan            TenantPlan  @default(FREE)
  customDomain    String?     @unique
  settings        Json?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  memberships     Membership[]
  invites         Invite[]
  owners          Owner[]
  pets            Pet[]
  petOwners       PetOwner[]
  kennels         Kennel[]
  bookings        Booking[]
  bookingSegments BookingSegment[]
  bookingServices BookingService[]
  services        Service[]
  payments        Payment[]
  staff           Staff[]
  vaccinations    Vaccination[]
  auditLogs       AuditLog[]
  usageCounters   UsageCounter[]
  checkIns        CheckIn[]
  checkOuts       CheckOut[]
  incidentReports IncidentReport[]
  communications  Communication[]
  notes           Note[]
  runs            Run[]
  runAssignments  RunAssignment[]
  messages        Message[]
  customerSegments CustomerSegment[]
  customerSegmentMembers CustomerSegmentMember[]
  customerTags    CustomerTag[]
  customerTagMembers CustomerTagMember[]
  campaigns       Campaign[]
  tasks           Task[]
}

model User {
  recordId        String    @id @default(cuid())
  email           String    @unique
  passwordHash    String
  lastLoginAt     DateTime?
  isActive        Boolean   @default(true)
  emailVerified   Boolean   @default(false)
  twoFactorSecret String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  name            String?
  phone           String?
  avatarUrl       String?
  timezone        String?   @default("America/New_York")
  language        String    @default("en")
  preferences     Json?     @default("{}")

  // Relations
  memberships    Membership[]
  createdInvites Invite[]
  auditLogs      AuditLog[]
  verificationTokens EmailVerificationToken[]
  communications Communication[]
  notes          Note[]
  campaigns      Campaign[]
  sentMessages   Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
}

model Membership {
  recordId     String   @id @default(cuid())
  userId       String
  tenantId     String
  role         Role     @default(STAFF)
  refreshToken String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [recordId], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  staff  Staff?

  @@unique([userId, tenantId])
  @@index([tenantId, role])
}

model Invite {
  recordId     String    @id @default(cuid())
  tenantId     String
  email        String
  token        String    @unique
  role         Role      @default(STAFF)
  expiresAt    DateTime
  acceptedAt   DateTime?
  createdById  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  createdBy User?  @relation(fields: [createdById], references: [recordId], onDelete: SetNull)

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
}

model EmailVerificationToken {
  recordId  String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [recordId], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model AuditLog {
  recordId   String   @id @default(cuid())
  tenantId   String
  actorId    String?
  action     String
  entityType String
  entityId   String?
  diff       Json?
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  actor  User?  @relation(fields: [actorId], references: [recordId], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([tenantId, entityType])
}

model UsageCounter {
  recordId     String   @id @default(cuid())
  tenantId     String
  date         DateTime
  bookings     Int      @default(0)
  activePets   Int      @default(0)
  staffSeats   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)

  @@unique([tenantId, date])
  @@index([tenantId, date])
}

model Staff {
  recordId     String   @id @default(cuid())
  tenantId     String
  membershipId String   @unique
  title        String?
  phone        String?
  schedule     Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant        Tenant     @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  membership    Membership @relation(fields: [membershipId], references: [recordId], onDelete: Cascade)
  checkIns      CheckIn[]
  checkOuts     CheckOut[]
  assignedTasks Task[]     @relation("TaskAssignedTo")
  completedTasks Task[]    @relation("TaskCompletedBy")

  @@index([tenantId])
}

model Owner {
  recordId     String    @id @default(cuid())
  tenantId     String
  firstName    String
  lastName     String
  email        String?
  phone        String?
  address      Json
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  pets           PetOwner[]
  bookings       Booking[]
  payments       Payment[]
  communications Communication[]
  segmentMembers CustomerSegmentMember[]
  tagMembers     CustomerTagMember[]

  @@unique([tenantId, email])
  @@index([tenantId, lastName])
}

model Pet {
  recordId        String    @id @default(cuid())
  tenantId        String
  name            String
  species         String?
  breed           String?
  birthdate       DateTime?
  photoUrl        String?
  medicalNotes    String?
  dietaryNotes    String?
  behaviorFlags   Json
  status          String    @default("active")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  weight          Float?
  allergies       String?
  lastVetVisit    DateTime?
  nextAppointment DateTime?

  tenant          Tenant           @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  owners          PetOwner[]
  vaccinations    Vaccination[]
  bookings        Booking[]
  incidentReports IncidentReport[]
  runAssignments  RunAssignment[]

  @@index([tenantId, name])
}

model PetOwner {
  recordId  String  @id @default(cuid())
  tenantId  String
  petId     String
  ownerId   String
  isPrimary Boolean @default(false)

  tenant Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  pet    Pet    @relation(fields: [petId], references: [recordId], onDelete: Cascade)
  owner  Owner  @relation(fields: [ownerId], references: [recordId], onDelete: Cascade)

  @@unique([tenantId, petId, ownerId])
  @@index([tenantId, ownerId])
}

model Kennel {
  recordId    String     @id @default(cuid())
  tenantId    String
  name        String
  type        KennelType
  size        String?
  capacity    Int        @default(1)
  location    String?
  amenities   String     @default("{}")
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  building    String?
  zone        String?
  hourlyRate  Int?
  dailyRate   Int?
  weeklyRate  Int?
  notes       String?

  tenant   Tenant           @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  bookings BookingSegment[]

  @@unique([tenantId, name])
  @@index([tenantId, type])
  @@index([tenantId, isActive])
}

model Booking {
  recordId            String          @id @default(cuid())
  tenantId            String
  petId               String
  ownerId             String
  status              BookingStatus   @default(PENDING)
  checkIn             DateTime
  checkOut            DateTime
  depositCents        Int             @default(0)
  totalCents          Int             @default(0)
  balanceDueCents     Int             @default(0)
  notes               String?
  specialInstructions String?
  source              String?         @default("portal")
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  pet             Pet              @relation(fields: [petId], references: [recordId], onDelete: Cascade)
  owner           Owner            @relation(fields: [ownerId], references: [recordId], onDelete: Cascade)
  segments        BookingSegment[]
  services        BookingService[]
  payments        Payment[]
  checkIns        CheckIn[]
  checkOuts       CheckOut[]
  incidentReports IncidentReport[]

  @@index([tenantId, status, checkIn])
  @@index([tenantId, petId])
}

model BookingSegment {
  recordId  String        @id @default(cuid())
  tenantId  String
  bookingId String
  kennelId  String
  startDate DateTime
  endDate   DateTime
  status    BookingStatus @default(CONFIRMED)
  notes     String?

  tenant  Tenant  @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  booking Booking @relation(fields: [bookingId], references: [recordId], onDelete: Cascade)
  kennel  Kennel  @relation(fields: [kennelId], references: [recordId], onDelete: Cascade)

  @@index([tenantId, startDate])
  @@index([tenantId, kennelId, startDate])
}

model Service {
  recordId    String          @id @default(cuid())
  tenantId    String
  name        String
  description String?
  priceCents  Int             @default(0)
  category    ServiceCategory @default(BOARDING)
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  tenant   Tenant           @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  bookings BookingService[]

  @@unique([tenantId, name])
}

model BookingService {
  recordId   String @id @default(cuid())
  tenantId   String
  bookingId  String
  serviceId  String
  quantity   Int    @default(1)
  priceCents Int    @default(0)

  tenant  Tenant  @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  booking Booking @relation(fields: [bookingId], references: [recordId], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [recordId], onDelete: Cascade)

  @@index([tenantId, bookingId])
}

model Vaccination {
  recordId       String    @id @default(cuid())
  tenantId       String
  petId          String
  type           String
  administeredAt DateTime
  expiresAt      DateTime
  documentUrl    String?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  reminderSentAt DateTime?

  tenant Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  pet    Pet    @relation(fields: [petId], references: [recordId], onDelete: Cascade)

  @@index([tenantId, expiresAt])
}

model Payment {
  recordId    String        @id @default(cuid())
  tenantId    String
  bookingId   String?
  ownerId     String
  amountCents Int
  currency    String        @default("USD")
  status      PaymentStatus @default(PENDING)
  method      String?
  externalId  String?
  intentId    String?
  capturedAt  DateTime?
  metadata    Json
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant  Tenant   @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [recordId], onDelete: Cascade)
  owner   Owner    @relation(fields: [ownerId], references: [recordId], onDelete: Cascade)

  @@unique([tenantId, externalId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([tenantId, intentId])
}

model CheckIn {
  recordId        String   @id @default(cuid())
  tenantId        String
  bookingId       String
  staffId         String?
  time            DateTime @default(now())
  weight          Float?
  photos          String   @default("[]")
  notes           String?
  conditionRating Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  booking Booking @relation(fields: [bookingId], references: [recordId], onDelete: Cascade)
  staff   Staff?  @relation(fields: [staffId], references: [recordId], onDelete: SetNull)

  @@index([tenantId, bookingId])
  @@index([tenantId, time])
}

model CheckOut {
  recordId         String          @id @default(cuid())
  tenantId         String
  bookingId        String
  staffId          String?
  time             DateTime        @default(now())
  incidentReportId String?
  extraCharges     String          @default("{}")
  signatureUrl     String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  booking        Booking         @relation(fields: [bookingId], references: [recordId], onDelete: Cascade)
  staff          Staff?          @relation(fields: [staffId], references: [recordId], onDelete: SetNull)
  incidentReport IncidentReport? @relation(fields: [incidentReportId], references: [recordId], onDelete: SetNull)

  @@index([tenantId, bookingId])
  @@index([tenantId, time])
}

model IncidentReport {
  recordId     String           @id @default(cuid())
  tenantId     String
  petId        String
  bookingId    String?
  occurredAt   DateTime         @default(now())
  severity     IncidentSeverity
  narrative    String
  photos       String           @default("[]")
  vetContacted Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  pet       Pet        @relation(fields: [petId], references: [recordId], onDelete: Cascade)
  booking   Booking?   @relation(fields: [bookingId], references: [recordId], onDelete: Cascade)
  checkOuts CheckOut[]

  @@index([tenantId, petId])
  @@index([tenantId, bookingId])
  @@index([tenantId, occurredAt])
}

model Communication {
  recordId  String                 @id @default(cuid())
  tenantId  String
  ownerId   String
  userId    String
  type      CommunicationType
  direction CommunicationDirection
  subject   String?
  content   String
  metadata  Json?
  createdAt DateTime               @default(now())
  updatedAt DateTime               @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  owner  Owner  @relation(fields: [ownerId], references: [recordId], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [recordId], onDelete: Cascade)

  @@index([tenantId, ownerId, createdAt])
  @@index([tenantId, type])
}

model CustomerSegment {
  recordId    String                  @id @default(cuid())
  tenantId    String
  name        String
  description String?
  conditions  Json
  isAutomatic Boolean                 @default(false)
  isActive    Boolean                 @default(true)
  color       String?
  icon        String?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @default(now())

  tenant    Tenant                  @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  members   CustomerSegmentMember[]
  campaigns Campaign[]

  @@unique([tenantId, name])
  @@index([tenantId, isActive])
}

model CustomerSegmentMember {
  recordId  String   @id @default(cuid())
  tenantId  String
  segmentId String
  ownerId   String
  addedAt   DateTime @default(now())
  isManual  Boolean  @default(false)

  tenant  Tenant          @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  segment CustomerSegment @relation(fields: [segmentId], references: [recordId], onDelete: Cascade)
  owner   Owner           @relation(fields: [ownerId], references: [recordId], onDelete: Cascade)

  @@unique([segmentId, ownerId])
  @@index([tenantId, ownerId])
}

model CustomerTag {
  recordId    String              @id @default(cuid())
  tenantId    String
  name        String
  color       String?
  description String?
  createdAt   DateTime            @default(now())

  tenant    Tenant              @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  customers CustomerTagMember[]

  @@unique([tenantId, name])
}

model CustomerTagMember {
  recordId String   @id @default(cuid())
  tenantId String
  tagId    String
  ownerId  String
  addedAt  DateTime @default(now())

  tenant Tenant      @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  tag    CustomerTag @relation(fields: [tagId], references: [recordId], onDelete: Cascade)
  owner  Owner       @relation(fields: [ownerId], references: [recordId], onDelete: Cascade)

  @@unique([tagId, ownerId])
  @@index([tenantId, ownerId])
}

model Campaign {
  recordId    String            @id @default(cuid())
  tenantId    String
  name        String
  description String?
  type        CommunicationType
  status      CampaignStatus    @default(DRAFT)
  segmentId   String?
  content     Json
  scheduledAt DateTime?
  sentAt      DateTime?
  metrics     Json?
  createdById String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @default(now())

  tenant    Tenant           @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  segment   CustomerSegment? @relation(fields: [segmentId], references: [recordId], onDelete: SetNull)
  createdBy User             @relation(fields: [createdById], references: [recordId], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, scheduledAt])
}

model Note {
  recordId   String         @id @default(cuid())
  tenantId   String
  entityType String
  entityId   String
  category   String?
  content    String
  visibility NoteVisibility @default(ALL)
  isPinned   Boolean        @default(false)
  authorId   String
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  author User   @relation(fields: [authorId], references: [recordId], onDelete: Cascade)

  @@index([tenantId, entityType, entityId])
  @@index([tenantId, authorId])
}

model Task {
  recordId     String    @id @default(cuid())
  tenantId     String
  type         TaskType
  relatedType  String
  relatedId    String
  assignedTo   String?
  scheduledFor DateTime
  completedAt  DateTime?
  completedBy  String?
  notes        String?
  priority     Priority  @default(NORMAL)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant           Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  staff            Staff? @relation("TaskAssignedTo", fields: [assignedTo], references: [recordId])
  completedByStaff Staff? @relation("TaskCompletedBy", fields: [completedBy], references: [recordId])

  @@index([tenantId, scheduledFor])
  @@index([tenantId, type])
  @@index([tenantId, assignedTo])
}

model Run {
  recordId     String          @id @default(cuid())
  tenantId     String
  name         String
  capacity     Int
  scheduleTime String
  color        String?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @default(now())

  tenant      Tenant          @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  assignments RunAssignment[]

  @@index([tenantId, isActive])
  @@map("runs")
}

model RunAssignment {
  recordId  String   @id @default(cuid())
  tenantId  String
  runId     String
  petId     String
  date      DateTime @db.Date
  notes     String?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  run    Run    @relation(fields: [runId], references: [recordId], onDelete: Cascade)
  pet    Pet    @relation(fields: [petId], references: [recordId], onDelete: Cascade)

  @@unique([runId, petId, date])
  @@index([tenantId, date])
  @@map("run_assignments")
}

model Message {
  recordId       String    @id @default(cuid())
  tenantId       String
  conversationId String
  senderId       String
  recipientId    String?
  content        String
  isRead         Boolean   @default(false)
  readAt         DateTime?
  createdAt      DateTime  @default(now())

  tenant    Tenant @relation(fields: [tenantId], references: [recordId], onDelete: Cascade)
  sender    User   @relation("SentMessages", fields: [senderId], references: [recordId])
  recipient User?  @relation("ReceivedMessages", fields: [recipientId], references: [recordId])

  @@index([tenantId, conversationId])
  @@index([tenantId, senderId])
  @@index([tenantId, recipientId])
  @@map("messages")
}
