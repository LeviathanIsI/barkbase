// Prisma schema for BarkBase kennel management system with multi-tenant isolation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum TenantPlan {
  FREE
  PRO
  ENTERPRISE
}

enum StorageProvider {
  SUPABASE
}



enum DbProvider {
  SUPABASE
}



enum MigrationState {
  IDLE
  STAGING
  DUALWRITE
  CUTOVER
  COMPLETE
  ROLLBACK
}


enum Role {
  OWNER
  ADMIN
  STAFF
  READONLY
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  CHECKED_OUT
  COMPLETED
  CANCELLED
}

enum IncidentSeverity {
  MINOR
  MODERATE
  SEVERE
  CRITICAL
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  REFUNDED
  FAILED
}

enum ServiceCategory {
  BOARDING
  DAYCARE
  GROOMING
  TRAINING
  OTHER
}

enum KennelType {
  SUITE
  KENNEL
  CABIN
  DAYCARE
  MEDICAL
}

model Tenant {
  id              String      @id @default(cuid())
  slug            String      @unique
  name            String
  themeJson       Json?
  featureFlags    Json?
  plan            TenantPlan  @default(FREE)
  storageProvider  StorageProvider  @default(SUPABASE)
  dbProvider       DbProvider       @default(SUPABASE)
  migrationState   MigrationState   @default(IDLE)
  migrationInfo    Json?
  customDomain    String?     @unique
  settings        Json?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  memberships     Membership[]
  invites         Invite[]    @relation("TenantInvites")
  owners          Owner[]
  pets            Pet[]
  petOwners       PetOwner[]
  kennels         Kennel[]
  bookings        Booking[]
  bookingSegments BookingSegment[]
  bookingServices BookingService[]
  services        Service[]
  payments        Payment[]
  staff           Staff[]
  vaccinations    Vaccination[]
  auditLogs       AuditLog[]
  usageCounters   UsageCounter[]
  checkIns        CheckIn[]
  checkOuts       CheckOut[]
  incidentReports IncidentReport[]
  customProperties CustomProperty[]
  @@index([slug])
}


model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String
  lastLoginAt    DateTime?
  isActive       Boolean   @default(true)
  emailVerified  Boolean   @default(false)
  twoFactorSecret String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  memberships    Membership[]
  createdInvites Invite[]   @relation("UserCreatedInvites")
  auditLogs      AuditLog[]
  verificationTokens EmailVerificationToken[]
}


model Membership {
  id           String   @id @default(cuid())
  userId       String
  tenantId     String
  role         Role     @default(STAFF)
  refreshToken String?
  localDataConsent Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  staff  Staff?

  @@unique([userId, tenantId])
  @@index([tenantId, role])
}

model Invite {
  id           String   @id @default(cuid())
  tenantId     String
  email        String
  token        String   @unique
  role         Role     @default(STAFF)
  expiresAt    DateTime
  acceptedAt   DateTime?
  createdById  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant   @relation("TenantInvites", fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy    User?    @relation("UserCreatedInvites", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([email])
  @@unique([tenantId, email])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String
  actorId     String?
  action      String
  entityType  String
  entityId    String?
  diff        Json?
  createdAt   DateTime @default(now())

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor       User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([tenantId, entityType])
}

model UsageCounter {
  id          String   @id @default(cuid())
  tenantId    String
  date        DateTime
  bookings    Int      @default(0)
  activePets  Int      @default(0)
  staffSeats  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date])
  @@index([tenantId, date])
}

model Staff {
  id            String   @id @default(cuid())
  tenantId      String
  membershipId  String   @unique
  title         String?
  phone         String?
  schedule      Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  membership    Membership  @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  checkIns      CheckIn[]
  checkOuts     CheckOut[]

  @@index([tenantId])
}


model Owner {
  id           String   @id @default(cuid())
  tenantId     String
  firstName    String
  lastName     String
  email        String?
  phone        String?
  address      Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pets         PetOwner[]
  bookings     Booking[]
  payments     Payment[]

  @@index([tenantId, lastName])
  @@unique([tenantId, email])
}

model Pet {
  id                 String       @id @default(cuid())
  tenantId           String
  name               String
  breed              String?
  birthdate          DateTime?
  photoUrl           String?
  medicalNotes       String?
  dietaryNotes       String?
  behaviorFlags      Json
  status             String      @default("active")
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  tenant             Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owners             PetOwner[]
  vaccinations       Vaccination[]
  bookings           Booking[]
  incidentReports    IncidentReport[]

  @@index([tenantId, name])
}

model PetOwner {
  id        String @id @default(cuid())
  tenantId  String
  petId     String
  ownerId   String
  isPrimary Boolean @default(false)

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pet       Pet    @relation(fields: [petId], references: [id], onDelete: Cascade)
  owner     Owner  @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([tenantId, petId, ownerId])
  @@index([tenantId, ownerId])
}

model Kennel {
  id         String     @id @default(cuid())
  tenantId   String
  name       String
  type       KennelType
  size       String?
  capacity   Int        @default(1)
  location   String?
  amenities  String     @default("{}")
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings   BookingSegment[]

  @@unique([tenantId, name])
  @@index([tenantId, type])
  @@index([tenantId, isActive])
}

model Booking {
  id                 String          @id @default(cuid())
  tenantId           String
  petId              String
  ownerId            String
  status             BookingStatus   @default(PENDING)
  checkIn            DateTime
  checkOut           DateTime
  depositCents       Int             @default(0)
  totalCents         Int             @default(0)
  balanceDueCents    Int             @default(0)
  notes              String?
  specialInstructions String?
  source             String?         @default("portal")
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  tenant             Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pet                Pet              @relation(fields: [petId], references: [id], onDelete: Cascade)
  owner              Owner            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  segments           BookingSegment[]
  services           BookingService[]
  payments           Payment[]
  checkIns           CheckIn[]
  checkOuts          CheckOut[]
  incidentReports    IncidentReport[]

  @@index([tenantId, status, checkIn])
  @@index([tenantId, petId])
}

model BookingSegment {
  id         String        @id @default(cuid())
  tenantId   String
  bookingId  String
  kennelId   String
  startDate  DateTime
  endDate    DateTime
  status     BookingStatus @default(CONFIRMED)
  notes      String?

  tenant     Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  booking    Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  kennel     Kennel        @relation(fields: [kennelId], references: [id], onDelete: Cascade)

  @@index([tenantId, startDate])
  @@index([tenantId, kennelId, startDate])
}

model Service {
  id          String          @id @default(cuid())
  tenantId    String
  name        String
  description String?
  priceCents  Int             @default(0)
  category    ServiceCategory @default(BOARDING)
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings    BookingService[]

  @@unique([tenantId, name])
}

model BookingService {
  id         String   @id @default(cuid())
  tenantId   String
  bookingId  String
  serviceId  String
  quantity   Int      @default(1)
  priceCents Int      @default(0)

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([tenantId, bookingId])
}

model Vaccination {
  id            String   @id @default(cuid())
  tenantId      String
  petId         String
  type          String
  administeredAt DateTime
  expiresAt     DateTime
  documentUrl   String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pet           Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([tenantId, expiresAt])
}

model Payment {
  id           String        @id @default(cuid())
  tenantId     String
  bookingId    String?
  ownerId      String
  amountCents  Int
  currency     String        @default("USD")
  status       PaymentStatus @default(PENDING)
  method       String?
  externalId   String?
  intentId     String?
  capturedAt   DateTime?
  metadata     Json
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  booking      Booking?      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  owner        Owner         @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([tenantId, intentId])
  @@unique([tenantId, externalId])
}

model CheckIn {
  id               String   @id @default(cuid())
  tenantId         String
  bookingId        String
  staffId          String?
  time             DateTime @default(now())
  weight           Float?
  photos           String   @default("[]")
  notes            String?
  conditionRating  Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  staff            Staff?   @relation(fields: [staffId], references: [id], onDelete: SetNull)

  @@index([tenantId, bookingId])
  @@index([tenantId, time])
}

model CheckOut {
  id               String   @id @default(cuid())
  tenantId         String
  bookingId        String
  staffId          String?
  time             DateTime @default(now())
  incidentReportId String?
  extraCharges     String   @default("{}")
  signatureUrl     String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  booking          Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  staff            Staff?          @relation(fields: [staffId], references: [id], onDelete: SetNull)
  incidentReport   IncidentReport? @relation(fields: [incidentReportId], references: [id], onDelete: SetNull)

  @@index([tenantId, bookingId])
  @@index([tenantId, time])
}

model IncidentReport {
  id            String            @id @default(cuid())
  tenantId      String
  petId         String
  bookingId     String?
  occurredAt    DateTime          @default(now())
  severity      IncidentSeverity
  narrative     String
  photos        String            @default("[]")
  vetContacted  Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pet           Pet               @relation(fields: [petId], references: [id], onDelete: Cascade)
  booking       Booking?          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  checkOuts     CheckOut[]

  @@index([tenantId, petId])
  @@index([tenantId, bookingId])
  @@index([tenantId, occurredAt])
}

model CustomProperty {
  id          String    @id @default(cuid())
  tenantId    String
  objectType  String
  name        String
  label       String
  description String?
  type        String
  group       String
  required    Boolean   @default(false)
  fieldConfig Json?
  archived    Boolean   @default(false)
  archivedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, objectType, name])
  @@index([tenantId, objectType])
  @@index([tenantId, objectType, archived])
}



