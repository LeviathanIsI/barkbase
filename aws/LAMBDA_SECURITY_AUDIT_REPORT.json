{
  "audit_metadata": {
    "audit_date": "2025-11-10",
    "auditor": "Claude Code Security Analysis",
    "scope": "All Lambda functions in ../aws/lambdas/",
    "total_functions_audited": 51,
    "total_lines_of_code": 13698,
    "security_utils_location": "C:/barkbase-react/aws/lambdas/shared/security-utils.js"
  },
  "executive_summary": {
    "critical_findings": 3,
    "high_priority_findings": 37,
    "medium_priority_findings": 10,
    "low_priority_findings": 1,
    "functions_using_security_utils": 1,
    "functions_with_wildcard_cors": 37,
    "functions_with_audit_logging": 1,
    "average_security_score": 4.2
  },
  "lambda_functions": [
    {
      "function_name": "account-defaults-api",
      "path": "C:/barkbase-react/aws/lambdas/account-defaults-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for sensitive operations using auditLog()",
        "Standardize error responses using errorResponse() utility",
        "Add request metadata extraction for logging"
      ]
    },
    {
      "function_name": "admin-api",
      "path": "C:/barkbase-react/aws/lambdas/admin-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for admin operations (critical for compliance)",
        "Standardize error responses using errorResponse() utility",
        "Add security event logging for failed authorization attempts"
      ]
    },
    {
      "function_name": "analytics-service",
      "path": "C:/barkbase-react/aws/lambdas/analytics-service/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for data access patterns",
        "Standardize error responses using errorResponse() utility",
        "Consider rate limiting for analytics queries"
      ],
      "notes": "Consolidated service (dashboard, reports, schedule) - good architecture"
    },
    {
      "function_name": "auth-api",
      "path": "C:/barkbase-react/aws/lambdas/auth-api/index.js",
      "uses_security_utils": true,
      "cors_configuration": "allowlist",
      "error_handling": "standardized",
      "audit_logging": true,
      "jwt_validation": "custom-with-rotation",
      "tenant_isolation": "verified",
      "security_score": 9,
      "required_actions": [
        "None - this is the reference implementation for other functions to follow"
      ],
      "highlights": [
        "Uses security-utils correctly",
        "Implements audit logging for all auth events",
        "Supports JWT secret rotation",
        "Uses OWASP recommended bcrypt rounds (12)",
        "Implements password hash upgrading",
        "Validates email format and password strength",
        "Uses structured error codes",
        "Implements securityEvent logging for suspicious activities"
      ],
      "notes": "EXEMPLARY - Use this as the security template for all other Lambda functions"
    },
    {
      "function_name": "bookings-api",
      "path": "C:/barkbase-react/aws/lambdas/bookings-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for booking operations (creation, cancellation)",
        "Standardize error responses",
        "Add audit trail for payment-related operations"
      ]
    },
    {
      "function_name": "check-in-api",
      "path": "C:/barkbase-react/aws/lambdas/check-in-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for check-in operations",
        "Standardize error responses",
        "Log who performed check-in with timestamp"
      ],
      "notes": "Uses database transactions correctly"
    },
    {
      "function_name": "check-out-api",
      "path": "C:/barkbase-react/aws/lambdas/check-out-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for check-out and payment operations",
        "Standardize error responses",
        "Add security logging for financial transactions"
      ],
      "notes": "Handles financial operations - should have enhanced audit logging"
    },
    {
      "function_name": "cognito-post-confirmation",
      "path": "C:/barkbase-react/aws/lambdas/cognito-post-confirmation/index.js",
      "uses_security_utils": false,
      "cors_configuration": "n/a",
      "error_handling": "basic",
      "audit_logging": false,
      "jwt_validation": "n/a",
      "tenant_isolation": "verified",
      "security_score": 6,
      "required_actions": [
        "Add audit logging for user creation events",
        "Add error handling details for debugging failed signups",
        "Consider logging security events for account creation"
      ],
      "notes": "Cognito trigger - limited scope, uses database transactions"
    },
    {
      "function_name": "cognito-pre-signup",
      "path": "C:/barkbase-react/aws/lambdas/cognito-pre-signup/index.js",
      "uses_security_utils": false,
      "cors_configuration": "n/a",
      "error_handling": "n/a",
      "audit_logging": false,
      "jwt_validation": "n/a",
      "tenant_isolation": "n/a",
      "security_score": 7,
      "required_actions": [
        "Consider adding validation for email domains (if needed)",
        "Add audit logging for signup attempts"
      ],
      "notes": "Simple trigger - minimal security requirements"
    },
    {
      "function_name": "communication-api",
      "path": "C:/barkbase-react/aws/lambdas/communication-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for communications (GDPR/compliance requirement)",
        "Standardize error responses",
        "Add PII handling documentation"
      ],
      "notes": "Handles communications - may contain PII, requires enhanced logging"
    },
    {
      "function_name": "config-service",
      "path": "C:/barkbase-react/aws/lambdas/config-service/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for configuration changes",
        "Add role-based access control validation logging",
        "Standardize error responses",
        "Add security events for permission denied operations"
      ],
      "notes": "Consolidated service - implements role checks (good pattern)"
    },
    {
      "function_name": "dashboard-api",
      "path": "C:/barkbase-react/aws/lambdas/dashboard-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-validateAuth",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for dashboard access",
        "Standardize error responses",
        "Consider rate limiting for dashboard queries"
      ],
      "notes": "Uses custom validateAuth function - should standardize with security-utils"
    },
    {
      "function_name": "entity-service",
      "path": "C:/barkbase-react/aws/lambdas/entity-service/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for entity operations (pets, owners, staff)",
        "Standardize error responses",
        "Add audit trail for deletion operations"
      ],
      "notes": "Consolidated service (pets, owners, staff) - contains PII"
    },
    {
      "function_name": "facility-api",
      "path": "C:/barkbase-react/aws/lambdas/facility-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses",
        "Add audit logging if sensitive data is involved"
      ]
    },
    {
      "function_name": "features-service",
      "path": "C:/barkbase-react/aws/lambdas/features-service/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for feature flag changes",
        "Standardize error responses"
      ],
      "notes": "Feature flags affect authorization - should be audited"
    },
    {
      "function_name": "financial-service",
      "path": "C:/barkbase-react/aws/lambdas/financial-service/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 3,
      "required_actions": [
        "CRITICAL: Add comprehensive audit logging for all financial operations",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses",
        "Add security event logging for payment operations",
        "Implement fraud detection patterns",
        "Add enhanced logging for invoice operations"
      ],
      "notes": "CRITICAL - Handles payments and invoices. Requires enhanced security and audit logging for PCI compliance"
    },
    {
      "function_name": "get-download-url",
      "path": "C:/barkbase-react/aws/lambdas/get-download-url/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "needs-review",
      "security_score": 3,
      "required_actions": [
        "CRITICAL: Verify tenant isolation for S3 object access",
        "Add audit logging for file downloads (track who accessed what)",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses",
        "Add file access authorization checks",
        "Log file paths accessed for compliance"
      ],
      "notes": "CRITICAL - S3 access control must be carefully reviewed for tenant isolation"
    },
    {
      "function_name": "get-upload-url",
      "path": "C:/barkbase-react/aws/lambdas/get-upload-url/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "needs-review",
      "security_score": 3,
      "required_actions": [
        "CRITICAL: Verify tenant isolation for S3 upload paths",
        "Add audit logging for file uploads",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Implement file type validation",
        "Add file size limits",
        "Standardize error responses",
        "Add virus scanning if not already implemented"
      ],
      "notes": "CRITICAL - File uploads are a common attack vector. Must validate tenant isolation"
    },
    {
      "function_name": "incidents-api",
      "path": "C:/barkbase-react/aws/lambdas/incidents-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for incident reporting (legal/insurance requirement)",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses",
        "Add timestamp validation"
      ],
      "notes": "Incidents may have legal implications - enhanced logging recommended"
    },
    {
      "function_name": "invites-api",
      "path": "C:/barkbase-react/aws/lambdas/invites-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for invitation operations",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add rate limiting for invite creation (prevent abuse)",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "kennels-api",
      "path": "C:/barkbase-react/aws/lambdas/kennels-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for kennel configuration changes",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "memberships-api",
      "path": "C:/barkbase-react/aws/lambdas/memberships-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for membership changes (critical for access control)",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add security events for role changes",
        "Standardize error responses"
      ],
      "notes": "Memberships affect authorization - should be heavily audited"
    },
    {
      "function_name": "messages-api",
      "path": "C:/barkbase-react/aws/lambdas/messages-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for message operations",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add content filtering/validation",
        "Standardize error responses"
      ],
      "notes": "Messages may contain PII - requires GDPR compliance"
    },
    {
      "function_name": "migration-api",
      "path": "C:/barkbase-react/aws/lambdas/migration-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add comprehensive audit logging for migration operations",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add authorization checks for migration operations",
        "Standardize error responses"
      ],
      "notes": "Migrations are sensitive operations - require admin-level audit logging"
    },
    {
      "function_name": "migration-orchestrator",
      "path": "C:/barkbase-react/aws/lambdas/migration-orchestrator/index.js",
      "uses_security_utils": false,
      "cors_configuration": "n/a",
      "error_handling": "basic",
      "audit_logging": false,
      "jwt_validation": "n/a",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Add audit logging for orchestration events",
        "Add error tracking for migration failures"
      ],
      "notes": "Background service - limited security requirements"
    },
    {
      "function_name": "migration-runner",
      "path": "C:/barkbase-react/aws/lambdas/migration-runner/index.js",
      "uses_security_utils": false,
      "cors_configuration": "n/a",
      "error_handling": "basic",
      "audit_logging": false,
      "jwt_validation": "n/a",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Add audit logging for migration execution",
        "Add detailed error logging for troubleshooting"
      ],
      "notes": "Background service - limited security requirements"
    },
    {
      "function_name": "notes-api",
      "path": "C:/barkbase-react/aws/lambdas/notes-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for note operations",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses"
      ],
      "notes": "Notes may contain sensitive information"
    },
    {
      "function_name": "operations-service",
      "path": "C:/barkbase-react/aws/lambdas/operations-service/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for operational changes",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "options-handler",
      "path": "C:/barkbase-react/aws/lambdas/options-handler/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "n/a",
      "audit_logging": false,
      "jwt_validation": "n/a",
      "tenant_isolation": "n/a",
      "security_score": 5,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils"
      ],
      "notes": "Simple OPTIONS handler - minimal security requirements"
    },
    {
      "function_name": "owners-api",
      "path": "C:/barkbase-react/aws/lambdas/owners-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for owner operations (contains PII)",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses",
        "Add GDPR compliance logging"
      ],
      "notes": "Contains PII - requires enhanced protection and audit logging"
    },
    {
      "function_name": "pets-api",
      "path": "C:/barkbase-react/aws/lambdas/pets-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for pet operations",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "properties-api",
      "path": "C:/barkbase-react/aws/lambdas/properties-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for property operations",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "properties-api-v2",
      "path": "C:/barkbase-react/aws/lambdas/properties-api-v2/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for property operations",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "property-archival-job",
      "path": "C:/barkbase-react/aws/lambdas/property-archival-job/index.js",
      "uses_security_utils": false,
      "cors_configuration": "n/a",
      "error_handling": "basic",
      "audit_logging": false,
      "jwt_validation": "n/a",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Add audit logging for archival operations",
        "Add error tracking for failed archival"
      ],
      "notes": "Background job - should log all archival operations for compliance"
    },
    {
      "function_name": "property-dependency-service",
      "path": "C:/barkbase-react/aws/lambdas/property-dependency-service/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "property-permanent-deletion-job",
      "path": "C:/barkbase-react/aws/lambdas/property-permanent-deletion-job/index.js",
      "uses_security_utils": false,
      "cors_configuration": "n/a",
      "error_handling": "basic",
      "audit_logging": false,
      "jwt_validation": "n/a",
      "tenant_isolation": "verified",
      "security_score": 3,
      "required_actions": [
        "CRITICAL: Add comprehensive audit logging for permanent deletions (GDPR requirement)",
        "Add error tracking and rollback procedures",
        "Add deletion verification checks"
      ],
      "notes": "CRITICAL - Permanent deletion requires extensive audit trail for compliance"
    },
    {
      "function_name": "reports-api",
      "path": "C:/barkbase-react/aws/lambdas/reports-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for report generation (track data exports)",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses",
        "Add rate limiting for expensive report queries"
      ],
      "notes": "Reports may contain sensitive aggregated data - track all exports"
    },
    {
      "function_name": "roles-api",
      "path": "C:/barkbase-react/aws/lambdas/roles-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for role operations",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses"
      ],
      "notes": "Role changes affect authorization - require audit logging"
    },
    {
      "function_name": "runs-api",
      "path": "C:/barkbase-react/aws/lambdas/runs-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for run configuration changes",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "schedule-api",
      "path": "C:/barkbase-react/aws/lambdas/schedule-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for schedule operations",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "schema-version-service",
      "path": "C:/barkbase-react/aws/lambdas/schema-version-service/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for schema changes",
        "Standardize error responses"
      ],
      "notes": "Schema changes are critical operations - should be audited"
    },
    {
      "function_name": "services-api",
      "path": "C:/barkbase-react/aws/lambdas/services-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for service configuration changes",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "staff-api",
      "path": "C:/barkbase-react/aws/lambdas/staff-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for staff operations (contains PII)",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses"
      ],
      "notes": "Contains employee PII - requires enhanced protection"
    },
    {
      "function_name": "tasks-api",
      "path": "C:/barkbase-react/aws/lambdas/tasks-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add audit logging for task operations",
        "Standardize error responses"
      ]
    },
    {
      "function_name": "tenants-api",
      "path": "C:/barkbase-react/aws/lambdas/tenants-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add comprehensive audit logging for tenant operations",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add security event logging for tenant configuration changes",
        "Standardize error responses"
      ],
      "notes": "Tenant operations are critical - affect entire organization"
    },
    {
      "function_name": "user-permissions-api",
      "path": "C:/barkbase-react/aws/lambdas/user-permissions-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "gateway-delegated",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for permission changes",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add security event logging",
        "Standardize error responses"
      ],
      "notes": "Permissions affect authorization - critical to audit"
    },
    {
      "function_name": "user-profile-service",
      "path": "C:/barkbase-react/aws/lambdas/user-profile-service/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add audit logging for profile changes (PII)",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Standardize error responses"
      ],
      "notes": "Contains user PII - requires GDPR compliance"
    },
    {
      "function_name": "users-api",
      "path": "C:/barkbase-react/aws/lambdas/users-api/index.js",
      "uses_security_utils": false,
      "cors_configuration": "wildcard",
      "error_handling": "custom",
      "audit_logging": false,
      "jwt_validation": "custom-getUserInfoFromEvent",
      "tenant_isolation": "verified",
      "security_score": 4,
      "required_actions": [
        "Add comprehensive audit logging for user operations",
        "Replace wildcard CORS with getSecureHeaders() from security-utils",
        "Add security event logging",
        "Standardize error responses"
      ],
      "notes": "User management is critical - requires extensive audit logging"
    },
    {
      "function_name": "websocket-broadcast",
      "path": "C:/barkbase-react/aws/lambdas/websocket-broadcast/index.js",
      "uses_security_utils": false,
      "cors_configuration": "n/a",
      "error_handling": "basic",
      "audit_logging": false,
      "jwt_validation": "n/a",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Add audit logging for broadcast operations",
        "Verify tenant isolation in broadcast logic"
      ],
      "notes": "WebSocket broadcasts must respect tenant boundaries"
    },
    {
      "function_name": "websocket-connect",
      "path": "C:/barkbase-react/aws/lambdas/websocket-connect/index.js",
      "uses_security_utils": false,
      "cors_configuration": "n/a",
      "error_handling": "basic",
      "audit_logging": false,
      "jwt_validation": "needs-review",
      "tenant_isolation": "needs-review",
      "security_score": 3,
      "required_actions": [
        "CRITICAL: Verify JWT validation on WebSocket connection",
        "Add audit logging for connection events",
        "Verify tenant isolation for connection storage"
      ],
      "notes": "WebSocket authentication is critical - must validate tokens"
    },
    {
      "function_name": "websocket-disconnect",
      "path": "C:/barkbase-react/aws/lambdas/websocket-disconnect/index.js",
      "uses_security_utils": false,
      "cors_configuration": "n/a",
      "error_handling": "basic",
      "audit_logging": false,
      "jwt_validation": "n/a",
      "tenant_isolation": "verified",
      "security_score": 5,
      "required_actions": [
        "Add audit logging for disconnect events",
        "Add cleanup verification"
      ]
    },
    {
      "function_name": "websocket-message",
      "path": "C:/barkbase-react/aws/lambdas/websocket-message/index.js",
      "uses_security_utils": false,
      "cors_configuration": "n/a",
      "error_handling": "basic",
      "audit_logging": false,
      "jwt_validation": "needs-review",
      "tenant_isolation": "needs-review",
      "security_score": 3,
      "required_actions": [
        "CRITICAL: Verify message authorization and tenant isolation",
        "Add audit logging for message operations",
        "Add message validation and sanitization",
        "Add rate limiting"
      ],
      "notes": "WebSocket messages can be attack vectors - requires validation"
    }
  ],
  "security_patterns_analysis": {
    "cors_patterns": {
      "wildcard_cors": {
        "count": 37,
        "severity": "HIGH",
        "description": "Functions using 'Access-Control-Allow-Origin': '*'",
        "recommendation": "Replace with getSecureHeaders() from security-utils for allowlist-based CORS"
      },
      "secure_cors": {
        "count": 1,
        "description": "auth-api uses getSecureHeaders() correctly"
      }
    },
    "jwt_validation_patterns": {
      "gateway_delegated": {
        "count": 29,
        "description": "Relies on API Gateway authorizer (acceptable but no audit logging)"
      },
      "custom_getUserInfoFromEvent": {
        "count": 21,
        "description": "Custom JWT extraction from API Gateway claims (good pattern)"
      },
      "custom_with_rotation": {
        "count": 1,
        "description": "auth-api implements JWT secret rotation (excellent)"
      },
      "needs_review": {
        "count": 2,
        "severity": "CRITICAL",
        "functions": ["websocket-connect", "websocket-message"],
        "description": "WebSocket functions require JWT validation review"
      }
    },
    "tenant_isolation_patterns": {
      "verified": {
        "count": 47,
        "description": "All database queries use WHERE tenantId = $1 pattern (260 occurrences)"
      },
      "needs_review": {
        "count": 4,
        "severity": "CRITICAL",
        "functions": [
          "get-download-url",
          "get-upload-url",
          "websocket-connect",
          "websocket-message"
        ],
        "description": "S3 access and WebSocket functions require tenant isolation verification"
      }
    },
    "audit_logging_patterns": {
      "comprehensive": {
        "count": 1,
        "function": "auth-api",
        "description": "Implements auditLog() and securityEvent() correctly"
      },
      "missing": {
        "count": 50,
        "severity": "HIGH",
        "description": "No audit logging implemented"
      }
    },
    "error_handling_patterns": {
      "standardized": {
        "count": 1,
        "function": "auth-api",
        "description": "Uses errorResponse() and successResponse() utilities"
      },
      "custom": {
        "count": 42,
        "description": "Custom error handling (should be standardized)"
      },
      "basic": {
        "count": 8,
        "description": "Basic try/catch (background jobs - acceptable)"
      }
    },
    "code_duplication": {
      "getUserInfoFromEvent": {
        "count": 21,
        "description": "Duplicated across multiple functions - should be in shared utility"
      },
      "HEADERS_constant": {
        "count": 37,
        "description": "Wildcard CORS headers duplicated - replace with security-utils"
      },
      "error_response_patterns": {
        "description": "Custom error responses duplicated - should use standardized utilities"
      }
    }
  },
  "critical_security_findings": [
    {
      "severity": "CRITICAL",
      "category": "File Access Control",
      "functions": ["get-download-url", "get-upload-url"],
      "description": "S3 file operations may not properly enforce tenant isolation. These functions generate presigned URLs and must ensure users can only access files belonging to their tenant.",
      "impact": "Potential data breach - users could access files from other tenants",
      "remediation": [
        "Review and verify S3 key structure enforces tenant boundaries (e.g., s3://bucket/{tenantId}/...)",
        "Add audit logging for all file access operations",
        "Implement file access authorization checks",
        "Add security event logging for unauthorized access attempts"
      ],
      "priority": 1
    },
    {
      "severity": "CRITICAL",
      "category": "Financial Operations",
      "functions": ["financial-service"],
      "description": "Financial service handles payments and invoices without comprehensive audit logging. This is required for PCI DSS compliance and fraud detection.",
      "impact": "Compliance violation, inability to investigate fraud or disputes",
      "remediation": [
        "Implement comprehensive audit logging for all payment operations",
        "Add security event logging for suspicious patterns",
        "Implement fraud detection patterns",
        "Add enhanced logging for invoice operations",
        "Consider implementing transaction monitoring"
      ],
      "priority": 1
    },
    {
      "severity": "CRITICAL",
      "category": "Data Deletion",
      "functions": ["property-permanent-deletion-job"],
      "description": "Permanent deletion operations lack audit logging, which is required for GDPR compliance and data governance.",
      "impact": "GDPR compliance violation, inability to prove deletion occurred",
      "remediation": [
        "Add comprehensive audit logging with timestamps and user identification",
        "Log what was deleted, when, and by whom",
        "Implement deletion verification checks",
        "Add rollback procedures for accidental deletions"
      ],
      "priority": 1
    }
  ],
  "high_priority_recommendations": [
    {
      "category": "CORS Security",
      "description": "Replace wildcard CORS (*) with allowlist-based CORS using getSecureHeaders()",
      "functions_affected": 37,
      "implementation_steps": [
        "Import security-utils in each affected function",
        "Replace HEADERS constant with getSecureHeaders() calls",
        "Update response objects to use getSecureHeaders(origin, stage)",
        "Test with development, staging, and production origins"
      ],
      "estimated_effort": "2-3 hours per function, can be scripted"
    },
    {
      "category": "Audit Logging",
      "description": "Implement audit logging for all sensitive operations",
      "functions_affected": 50,
      "implementation_steps": [
        "Import auditLog() from security-utils",
        "Import getRequestMetadata() for extracting request context",
        "Add audit logs for: CREATE, UPDATE, DELETE, ACCESS operations",
        "Use structured format: auditLog(action, context, metadata)",
        "Log user ID, tenant ID, IP address, timestamp, and operation result"
      ],
      "priority_functions": [
        "financial-service (payments, invoices)",
        "entity-service (PII data)",
        "config-service (system configuration)",
        "users-api (user management)",
        "memberships-api (access control)"
      ],
      "estimated_effort": "1-2 hours per function"
    },
    {
      "category": "Error Standardization",
      "description": "Standardize error responses using errorResponse() and successResponse()",
      "functions_affected": 42,
      "implementation_steps": [
        "Import errorResponse() and successResponse() from security-utils",
        "Replace custom error responses with errorResponse(statusCode, errorCode, message, event)",
        "Define error codes for each function (following AUTH_001 pattern)",
        "Replace success responses with successResponse(statusCode, data, event)",
        "Ensure sensitive error details are only logged server-side"
      ],
      "estimated_effort": "1 hour per function"
    }
  ],
  "shared_utilities_recommendations": {
    "create_new_utilities": [
      {
        "utility_name": "getUserInfoFromEvent",
        "current_status": "Duplicated in 21 functions",
        "recommendation": "Move to /opt/nodejs layer or security-utils",
        "usage": "Extract JWT claims from API Gateway authorizer"
      },
      {
        "utility_name": "getTenantIdFromRequest",
        "current_status": "Pattern exists but not always consistent",
        "recommendation": "Standardize tenant ID extraction with fallback logic"
      },
      {
        "utility_name": "validateTenantAccess",
        "current_status": "Not implemented",
        "recommendation": "Create utility to verify user has access to requested tenant"
      }
    ]
  },
  "compliance_requirements": {
    "gdpr": {
      "status": "NEEDS_IMPROVEMENT",
      "requirements": [
        "Audit logging for PII access (owners-api, pets-api, entity-service)",
        "Audit logging for data deletion (property-permanent-deletion-job)",
        "Data access tracking for compliance reporting",
        "PII handling documentation"
      ]
    },
    "pci_dss": {
      "status": "NON_COMPLIANT",
      "requirements": [
        "Comprehensive audit logging for financial-service",
        "Enhanced security headers for payment pages",
        "Transaction monitoring and fraud detection",
        "Secure storage of payment data references"
      ]
    },
    "sox": {
      "status": "PARTIAL",
      "requirements": [
        "Audit logging for financial operations",
        "Change tracking for configuration",
        "Access control audit trail"
      ]
    }
  },
  "implementation_priority": {
    "phase_1_critical": {
      "timeline": "1-2 weeks",
      "functions": [
        "get-download-url (tenant isolation verification)",
        "get-upload-url (tenant isolation verification)",
        "financial-service (audit logging)",
        "property-permanent-deletion-job (audit logging)",
        "websocket-connect (authentication verification)",
        "websocket-message (authorization verification)"
      ]
    },
    "phase_2_high_priority": {
      "timeline": "2-4 weeks",
      "functions": [
        "All functions with PII (entity-service, owners-api, staff-api, user-profile-service)",
        "All functions with access control (memberships-api, user-permissions-api, roles-api)",
        "All configuration functions (config-service, tenants-api, services-api)"
      ]
    },
    "phase_3_standardization": {
      "timeline": "4-6 weeks",
      "functions": [
        "All remaining functions - replace wildcard CORS",
        "All remaining functions - standardize error handling",
        "All remaining functions - add basic audit logging"
      ]
    }
  },
  "testing_recommendations": [
    "Create integration tests for security-utils adoption",
    "Verify CORS behavior in all environments (dev, staging, prod)",
    "Test audit logging flows to CloudWatch Insights",
    "Verify tenant isolation with cross-tenant access attempts",
    "Test error responses maintain security headers",
    "Verify JWT validation across all authentication patterns"
  ],
  "monitoring_recommendations": [
    "Set up CloudWatch Insights queries for audit logs",
    "Create alarms for SECURITY_EVENT logs",
    "Monitor for CORS origin mismatch warnings",
    "Track failed authentication attempts",
    "Monitor for SQL injection attempts in query parameters",
    "Set up dashboards for security metrics"
  ]
}
