<%- include("../../partials/header.ejs") %>
    <%- include("../../partials/guestNav.ejs") %>
        <div class="settingsleft">
            <h1>Your Information</h1>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">Username <span
                        class="ms-auto">
                        <%= currentUser.userName %>
                    </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">Email <span
                        class="ms-auto">
                        <%= currentUser.email %>
                    </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">Residential Address
                    <span class="ms-auto address-padding" id="userAddress">
                        <%= currentUser.address %>
                            <br>
                            <%= currentUser.city %>,
                                <%= currentUser.state %>
                                    <%= currentUser.zip %>
                    </span>
                    <button type="button" onclick="openForm()" class="btn btn-primary btn-sm">Edit</button>
                </li>
                <li class="list-group-item">
                    <a class="changepassword" href="/guest/settings/password"><strong>Change Password</strong></a>
                </li>
                <li class="list-group-item">
                    <form action="/sessions/logout?_method=DELETE" method="POST">
                        <button type="submit" class="signout btn btn-default">
                            <strong>Sign Out</strong>
                        </button>
                    </form>
                </li>
            </ul>
        </div>

        <!-- Pop-up Form Container for Residential Address -->
        <div id="popupForm" class="popup-container" style="display:none;">
            <div class="popup-content">
                <span class="close-btn" onclick="closeForm()">&times;</span>
                <h2>Update Residential Address</h2>
                <form id="updateAddressForm" action="/guest/settings" method="POST">
                    <label for="address">Address:</label>
                    <input type="text" id="address" name="address" required>
                    <label for="city">City:</label>
                    <input type="text" id="city" name="city" required>
                    <label for="state">State:</label>
                    <input type="text" id="state" name="state" required>
                    <label for="zip">Zip:</label>
                    <input type="text" id="zip" name="zip" required>
                    <button type="submit">Update</button>
                </form>
            </div>
        </div>

        <% include("../../partials/footer.ejs") %>

            <!-- Script for handling pop up form for updating residential address -->
            <script>
                // Define openForm and closeForm functions globally
                window.openForm = function () {
                    document.getElementById("popupForm").style.display = "block";
                };

                window.closeForm = function () {
                    document.getElementById("popupForm").style.display = "none";
                };

                // Continue with your existing script
                document.addEventListener("DOMContentLoaded", function () {
                    document.getElementById("updateAddressForm").addEventListener("submit", function (event) {
                        event.preventDefault();

                        const formData = new FormData(this);
                        const data = {
                            address: formData.get("address"),
                            city: formData.get("city"),
                            state: formData.get("state"),
                            zip: formData.get("zip")
                        };

                        fetch("/guest/settings", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(data),
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.success) {
                                    const newAddressString = `${data.address}<br>${data.city}, ${data.state} ${data.zip}`;
                                    document.getElementById('userAddress').innerHTML = newAddressString;

                                    closeForm();
                                } else {
                                    throw new Error(data.message || 'Failed to update the address.');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Failed to update the address. Please try again.');
                            });
                    });
                });
            </script>