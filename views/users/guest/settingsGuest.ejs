<%- include("../../partials/header.ejs") %>
    <%- include("../../partials/guestNav.ejs") %>
        <div class="settingsleft">
            <h1>Settings</h1>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">Name <span
                        class="ms-auto">
                        <%= currentUser.userName %>
                    </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">Email <span
                        class="ms-auto">
                        <%= currentUser.email %>
                    </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">Residential Address <span
                        class="ms-auto">
                        <%= currentUser.address %>
                    </span> <a href="#" onclick="openForm()">Edit</a>
                </li>
                <li class="list-group-item">
                    Registered Pets
                    <% if (currentUser.pets && currentUser.pets.length> 0) { %>
                        <ul>
                            <% currentUser.pets.forEach(function(pet) { %>
                                <li id="petItem_<%= pet._id %>">
                                    <%= pet.name %>
                                        <button class="deletePetBtn" data-pet-id="<%= pet._id %>">DELETE</button>
                                </li>
                                <% }); %>
                        </ul>
                        <% } else { %>
                            <span class="ms-auto">No pets registered</span>
                            <% } %>
                                <a href="/guest/pets/add">Add Pets</a>
                </li>


                <li class="list-group-item">
                    <a class="changepassword" href="/guest/settings/password"><strong>Change Password</strong></a>
                </li>
                <li class="list-group-item">
                    <form action="/sessions/logout?_method=DELETE" method="POST">
                        <button type="submit" class="signout btn btn-default">
                            <strong>Sign Out</strong>
                        </button>
                    </form>
                </li>
            </ul>
        </div>

        <!-- Pop-up Form Container for Residential Address -->
        <div id="popupForm" class="popup-container" style="display:none;">
            <div class="popup-content">
                <span class="close-btn" onclick="closeForm()">&times;</span>
                <h2>Update Residential Address</h2>
                <form id="updateAddressForm" action="/guest/settings" method="POST">
                    <label for="address">New Address:</label>
                    <input type="text" id="address" name="address">
                    <button type="submit">Update</button>
                </form>
            </div>
        </div>
        <% include("../../partials/footer.ejs") %>

            <script>
                function openForm() {
                    document.getElementById("popupForm").style.display = "block";
                }

                function closeForm() {
                    document.getElementById("popupForm").style.display = "none";
                }
                document.addEventListener("DOMContentLoaded", function () {
                    document.getElementById("updateAddressForm").addEventListener("submit", function (event) {
                        event.preventDefault();

                        const formData = new FormData(this);
                        const address = formData.get("address");
                        const data = { address: address };

                        fetch("/guest/settings", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(data),
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log(data);
                                closeForm();
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                            });
                    });
                });
            </script>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    document.querySelectorAll('.deletePetBtn').forEach(button => {
                        button.addEventListener('click', function () {
                            const petId = this.getAttribute('data-pet-id');
                            fetch(`/guest/pets/${petId}`, {
                                method: 'DELETE',
                                credentials: "include"
                            })
                                .then(response => {
                                    if (response.ok) {
                                        // Remove the pet element from the DOM
                                        document.getElementById(`petItem_${petId}`).remove();
                                    } else {
                                        // Handle failure
                                        alert('Failed to delete the pet. Please try again.');
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                        });
                    });
                });
            </script>