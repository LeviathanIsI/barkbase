# Network & Database Design

This document describes the networking and database infrastructure for BarkBase Dev v2.

**Phase:** 2 of BarkBase Dev v2 Rebuild  
**Region:** us-east-2 (Ohio)  
**Last Updated:** Phase 2 implementation

---

## NetworkStack

The `NetworkStack` provides all core networking infrastructure for BarkBase. It must be deployed first as all other stacks depend on it.

### VPC Configuration

| Property | Value |
|----------|-------|
| CIDR Block | `10.0.0.0/16` |
| Availability Zones | 2 (us-east-2a, us-east-2b) |
| DNS Hostnames | Enabled |
| DNS Support | Enabled |

### Subnet Structure

| Subnet Type | Purpose | CIDR Mask | Count |
|-------------|---------|-----------|-------|
| **Public** | NAT Gateway, future bastion/tooling | /24 | 2 (one per AZ) |
| **Private (App)** | Lambda functions, RDS, application compute | /24 | 2 (one per AZ) |

Subnet naming convention:
- Public: `BarkbaseDevV2/Public/AZ1`, `BarkbaseDevV2/Public/AZ2`
- Private: `BarkbaseDevV2/App/AZ1`, `BarkbaseDevV2/App/AZ2`

### NAT Gateway

- **Count:** 1 (single NAT for cost control in dev)
- **Location:** Public subnet in first AZ
- **Purpose:** Allows private subnet resources (Lambdas) to reach internet

> **Note:** For production, increase to 2+ NAT Gateways for high availability.

### Security Groups

#### Lambda Security Group (`lambdaSecurityGroup`)
- **Purpose:** Used by Lambda functions and future application compute
- **Inbound:** None by default (consumers add rules as needed)
- **Outbound:** All traffic allowed (Lambdas need to reach AWS services)
- **Name:** `barkbase-dev-lambda-sg`

#### Database Security Group (`dbSecurityGroup`)
- **Purpose:** Used by RDS PostgreSQL instance
- **Inbound:** TCP 5432 from `lambdaSecurityGroup` only
- **Outbound:** None (database doesn't initiate outbound connections)
- **Name:** `barkbase-dev-db-sg`

### VPC Endpoints

Interface endpoints are created to allow private subnet resources to reach AWS services without going through NAT Gateway (cost optimization):

| Endpoint | Service | Purpose |
|----------|---------|---------|
| Secrets Manager | `com.amazonaws.us-east-2.secretsmanager` | Lambda retrieval of DB credentials |
| CloudWatch Logs | `com.amazonaws.us-east-2.logs` | Lambda logging |

Both endpoints:
- Are placed in private subnets
- Have private DNS enabled
- Use the `lambdaSecurityGroup`

### Exports

| Export | Type | Description |
|--------|------|-------------|
| `vpc` | `ec2.Vpc` | The VPC resource |
| `appSubnets` | `ec2.ISubnet[]` | Private subnets for app workloads |
| `publicSubnets` | `ec2.ISubnet[]` | Public subnets |
| `lambdaSecurityGroup` | `ec2.SecurityGroup` | SG for Lambda functions |
| `dbSecurityGroup` | `ec2.SecurityGroup` | SG for database |

---

## DatabaseStack

The `DatabaseStack` provides the PostgreSQL database for all BarkBase tenant data. It depends on `NetworkStack`.

### RDS Configuration

| Property | Value |
|----------|-------|
| Engine | PostgreSQL 15 |
| Instance Class | `db.t3.micro` (dev-appropriate) |
| Instance Identifier | `barkbase-dev-postgres` |
| Database Name | `barkbase` |
| Multi-AZ | No (single AZ for dev) |
| Publicly Accessible | **No** (private subnets only) |

### Storage

| Property | Value |
|----------|-------|
| Allocated Storage | 20 GiB |
| Max Allocated Storage | 100 GiB (autoscaling) |
| Storage Type | GP2 (General Purpose SSD) |

### Credentials

- **Username:** `barkbase_admin`
- **Password:** Auto-generated by CDK
- **Storage:** AWS Secrets Manager
- **Secret Name:** `barkbase-dev/db-credentials`

> **CRITICAL:** Credentials are NEVER hardcoded. All applications must retrieve credentials from Secrets Manager at runtime.

The secret JSON contains:
```json
{
  "username": "barkbase_admin",
  "password": "<auto-generated>",
  "host": "<rds-endpoint>",
  "port": "5432",
  "dbname": "barkbase",
  "engine": "postgres"
}
```

### Backup & Maintenance

| Property | Value |
|----------|-------|
| Backup Retention | 7 days |
| Maintenance Window | Sunday 03:00-04:00 UTC |
| Delete Automated Backups | Yes (dev only) |

### Dev Environment Settings

> ⚠️ **WARNING:** These settings are for development only. Change for production!

| Property | Dev Value | Production Recommendation |
|----------|-----------|--------------------------|
| Deletion Protection | `false` | `true` |
| Removal Policy | `DESTROY` | `RETAIN` or `SNAPSHOT` |
| Multi-AZ | `false` | `true` |
| Instance Class | `t3.micro` | `r6g.large` or larger |
| Performance Insights | Disabled | Enabled |
| Enhanced Monitoring | Disabled | Enabled (60s interval) |

### Networking

- **VPC:** From NetworkStack
- **Subnets:** Private (App) subnets only
- **Security Group:** `dbSecurityGroup` from NetworkStack
- **Public Access:** Disabled

### Exports

| Export | Type | Description |
|--------|------|-------------|
| `instance` | `rds.DatabaseInstance` | The RDS instance |
| `dbSecret` | `secretsmanager.ISecret` | Secret with credentials |
| `dbSecurityGroup` | `ec2.ISecurityGroup` | Re-exported from props |
| `hostname` | `string` | Database endpoint address |
| `port` | `string` | Database port (5432) |
| `dbName` | `string` | Database name (barkbase) |

---

## Cross-Stack References

### DatabaseStack Consumes from NetworkStack

```typescript
const databaseStack = new DatabaseStack(app, 'BarkBase-Dev-Database', {
  vpc: networkStack.vpc,
  dbSecurityGroup: networkStack.dbSecurityGroup,
  appSubnets: networkStack.appSubnets,
});
```

### Future Stacks Will Consume

Service stacks (to be implemented in later phases) will need:

| From NetworkStack | Used By |
|-------------------|---------|
| `vpc` | All Lambda-based service stacks |
| `lambdaSecurityGroup` | All Lambda functions |
| `appSubnets` | Lambda VPC configuration |

| From DatabaseStack | Used By |
|--------------------|---------|
| `dbSecret` | All Lambdas needing DB access |
| `hostname` | Database connection config |
| `port` | Database connection config |
| `dbName` | Database connection config |

### Dependency Chain

```
NetworkStack (Layer 1)
    ↓
DatabaseStack (Layer 2)
    ↓
[Service Stacks - Layer 3+]
    - TenantsServicesStack
    - IdentityServicesStack
    - EntityServicesStack
    - etc.
    ↓
ApiCoreStack (Layer 8)
    ↓
FrontendStack (Layer 9)
```

---

## For ChatGPT Summary

Key facts about BarkBase Dev v2 Network & Database infrastructure:

1. **Region:** us-east-2 (Ohio)
2. **VPC CIDR:** 10.0.0.0/16 with 2 availability zones
3. **Subnets:** 2 public (NAT) + 2 private (App) subnets, /24 each
4. **NAT Gateway:** 1 (cost control for dev; increase for prod)
5. **Security Groups:** 
   - `lambdaSecurityGroup` for Lambda/app compute (outbound all)
   - `dbSecurityGroup` for RDS (inbound 5432 from lambda SG only)
6. **VPC Endpoints:** Secrets Manager + CloudWatch Logs (cost optimization)
7. **Database Engine:** PostgreSQL 15 on RDS
8. **Database Name:** `barkbase` (multi-tenant via tenant_id column)
9. **Instance Class:** t3.micro for dev (scale up for prod)
10. **Credentials:** Auto-generated, stored in Secrets Manager (`barkbase-dev/db-credentials`)
11. **Security:** DB in private subnets, no public access, SG-restricted
12. **Dev Settings:** deletionProtection=false, removalPolicy=DESTROY
13. **Cross-Stack:** DatabaseStack depends on NetworkStack (vpc, dbSecurityGroup)
14. **Future:** Service stacks will consume vpc, lambdaSecurityGroup, dbSecret, hostname, port, dbName
15. **Resource Count:** ~30-40 total resources across both stacks (well under 500 limit)

