# BarkBase AWS Infrastructure - Phase 1 & 2

> **Status**: Ready for deployment  
> **Last Updated**: November 2024  
> **Phases Covered**: Foundation (Network + Database) + Shared Resources (DB Layer)

## Overview

This document covers the foundational AWS infrastructure for BarkBase:

**Phase 1 - Foundation:**
- VPC with public, private, and isolated subnets
- Security groups for application and database tiers
- RDS PostgreSQL database with Secrets Manager integration

**Phase 2 - Shared Resources:**
- Database Lambda Layer (`db-layer`) for PostgreSQL connectivity
- Secrets Manager integration for credential management

## Prerequisites

Before deploying, ensure you have:

1. **AWS CLI configured** with appropriate credentials
2. **AWS CDK CLI installed**: `npm install -g aws-cdk`
3. **Node.js 18+** installed
4. **AWS Account bootstrapped for CDK**:
   ```bash
   cdk bootstrap aws://ACCOUNT_ID/REGION
   ```

## Deployment

### Install Dependencies

```bash
cd aws/cdk
npm install

# Also install db-layer dependencies
cd ../layers/db-layer/nodejs
npm install
```

### Bootstrap (First Time Only)

This account uses a custom bootstrap qualifier `barkbase01`:

```bash
cdk bootstrap aws://211125574375/us-east-2 --qualifier barkbase01
```

> **Note**: The qualifier is already configured in `cdk.json` so you don't need to specify it on deploy commands.

### Deploy All Stacks

```bash
# Deploy Phase 1 + Phase 2 stacks
cdk deploy Barkbase-NetworkStack-dev Barkbase-DatabaseStack-dev Barkbase-SharedResourcesStack-dev

# Or deploy individually (in order)
cdk deploy Barkbase-NetworkStack-dev
cdk deploy Barkbase-DatabaseStack-dev
cdk deploy Barkbase-SharedResourcesStack-dev
```

### Environment Configuration

Set the environment via context:
```bash
# Development (default)
cdk deploy --context env=dev

# Production
cdk deploy --context env=prod
```

---

## Stack: Barkbase-NetworkStack-{env}

### Purpose
Creates all foundational networking resources for BarkBase.

### Resources Created

| Resource | Description |
|----------|-------------|
| VPC | CIDR: 10.0.0.0/16, 2 Availability Zones |
| Public Subnets | For NAT Gateway, load balancers |
| Private Subnets | For Lambda functions, application tier |
| Isolated Subnets | For RDS database (no internet access) |
| NAT Gateway | Single NAT for dev/staging (cost optimization) |
| App Security Group | For Lambda functions and app tier |
| Database Security Group | For RDS, allows inbound from App SG on port 5432 |
| VPC Flow Logs | Logs rejected traffic to CloudWatch |

### CloudFormation Outputs

| Output Key | Description | Export Name |
|------------|-------------|-------------|
| `VpcId` | VPC identifier | `Barkbase-NetworkStack-{env}-VpcId` |
| `VpcCidr` | VPC CIDR block | `Barkbase-NetworkStack-{env}-VpcCidr` |
| `PrivateSubnetIds` | Private subnet IDs (comma-separated) | `Barkbase-NetworkStack-{env}-PrivateSubnetIds` |
| `IsolatedSubnetIds` | Isolated subnet IDs for RDS | `Barkbase-NetworkStack-{env}-IsolatedSubnetIds` |
| `PublicSubnetIds` | Public subnet IDs | `Barkbase-NetworkStack-{env}-PublicSubnetIds` |
| `AppSecurityGroupId` | App/Lambda security group ID | `Barkbase-NetworkStack-{env}-AppSecurityGroupId` |
| `DatabaseSecurityGroupId` | Database security group ID | `Barkbase-NetworkStack-{env}-DatabaseSecurityGroupId` |

### SSM Parameters

| Parameter Path | Description |
|----------------|-------------|
| `/barkbase/{env}/network/vpc-id` | VPC ID |
| `/barkbase/{env}/network/app-sg-id` | App Security Group ID |
| `/barkbase/{env}/network/db-sg-id` | Database Security Group ID |

---

## Stack: Barkbase-DatabaseStack-{env}

### Purpose
Creates the PostgreSQL RDS database with Secrets Manager credentials.

### Dependencies
- **Barkbase-NetworkStack-{env}**: Requires VPC, isolated subnets, and database security group

### Resources Created

| Resource | Description |
|----------|-------------|
| RDS PostgreSQL Instance | PostgreSQL 15, db.t3.micro (dev) |
| DB Subnet Group | Uses isolated subnets |
| DB Parameter Group | Custom PostgreSQL parameters |
| Secrets Manager Secret | Database credentials |

### Database Configuration

| Setting | Value (Dev) | Notes |
|---------|-------------|-------|
| Engine | PostgreSQL 15 | |
| Instance Class | db.t3.micro | Use db.t3.small+ for prod |
| Storage | 20 GB GP3 | Auto-scales to 100 GB |
| Multi-AZ | Disabled | Enable for prod |
| Encryption | Enabled | At rest |
| Backup Retention | 7 days | |
| Database Name | `barkbase` | |
| Username | `barkbase_admin` | |
| Port | 5432 | |

### Secrets Manager

**Secret Name**: `barkbase/{env}/postgres/credentials`

The secret contains a JSON object with:
```json
{
  "username": "barkbase_admin",
  "password": "<auto-generated>",
  "engine": "postgres",
  "host": "<rds-endpoint>",
  "port": 5432,
  "dbname": "barkbase",
  "dbInstanceIdentifier": "barkbase-{env}-postgres"
}
```

**Retrieve credentials via CLI**:
```bash
aws secretsmanager get-secret-value \
  --secret-id barkbase/dev/postgres/credentials \
  --query SecretString --output text | jq
```

### CloudFormation Outputs

| Output Key | Description | Export Name |
|------------|-------------|-------------|
| `DatabaseEndpoint` | RDS endpoint address | `Barkbase-DatabaseStack-{env}-DatabaseEndpoint` |
| `DatabasePort` | RDS port (5432) | `Barkbase-DatabaseStack-{env}-DatabasePort` |
| `DatabaseName` | Database name | `Barkbase-DatabaseStack-{env}-DatabaseName` |
| `DatabaseSecretArn` | Secret ARN | `Barkbase-DatabaseStack-{env}-DatabaseSecretArn` |
| `DatabaseSecretName` | Secret name | `Barkbase-DatabaseStack-{env}-DatabaseSecretName` |
| `DatabaseInstanceId` | RDS instance identifier | `Barkbase-DatabaseStack-{env}-DatabaseInstanceId` |

### SSM Parameters

| Parameter Path | Description |
|----------------|-------------|
| `/barkbase/{env}/db/host` | Database endpoint |
| `/barkbase/{env}/db/port` | Database port |
| `/barkbase/{env}/db/name` | Database name |
| `/barkbase/{env}/db/secret-arn` | Credentials secret ARN |
| `/barkbase/{env}/db/secret-name` | Credentials secret name |

---

## Stack: Barkbase-SharedResourcesStack-{env}

### Purpose
Creates shared Lambda layers and resources used by all service stacks.

### Dependencies
None - can be deployed independently.

### Resources Created

| Resource | Description |
|----------|-------------|
| DbLayer | Lambda layer with PostgreSQL client and Secrets Manager integration |

### CloudFormation Outputs

| Output Key | Description | Export Name |
|------------|-------------|-------------|
| `DbLayerArn` | ARN of the database Lambda layer | `Barkbase-SharedResourcesStack-{env}-DbLayerArn` |

---

## Database Layer (db-layer)

### Location
`aws/layers/db-layer/nodejs/`

### Module: `db.js`

Exports:
- `getPool()` - Returns a singleton `pg.Pool` instance
- `warmUp()` - Explicitly initialize pool (for cold start optimization)
- `closePool()` - Gracefully close the pool

### Configuration Modes

**1. Secret-Based (Lambda/Production)**

Set `DB_SECRET_NAME` environment variable:
```bash
DB_SECRET_NAME=barkbase/dev/postgres/credentials
AWS_REGION=us-east-2
```

The module will:
1. Fetch credentials from AWS Secrets Manager
2. Cache the secret in memory
3. Configure the pool with SSL for RDS

**2. Direct Environment (Local Development)**

If `DB_SECRET_NAME` is not set, use direct variables:
```bash
DB_HOST=localhost
DB_PORT=5432
DB_NAME=barkbase
DB_USER=postgres
DB_PASSWORD=your_password
```

### Lambda Environment Variables

When attaching the db-layer to Lambda functions, set these env vars:

| Variable | Value | Description |
|----------|-------|-------------|
| `DB_SECRET_NAME` | `barkbase/{env}/postgres/credentials` | Secrets Manager secret name |
| `DB_NAME` | `barkbase` | Database name |
| `BARKBASE_ENV` | `dev` | Environment name |
| `AWS_NODEJS_CONNECTION_REUSE_ENABLED` | `1` | HTTP keep-alive for better performance |

### Usage in Lambda

```javascript
// In Lambda (layer mounted at /opt/nodejs/)
const { getPool } = require('/opt/nodejs/db');

exports.handler = async (event) => {
  const pool = getPool();
  const result = await pool.query('SELECT * FROM "Pet" WHERE "tenantId" = $1', [tenantId]);
  return { statusCode: 200, body: JSON.stringify(result.rows) };
};
```

### Usage in Backend (Local)

```javascript
// In backend/src/lib/db/index.js - automatic resolution
const { getPool } = require('../../lib/db');

// Uses db-layer from Lambda path or falls back to local path
const pool = getPool();
const result = await pool.query('SELECT NOW()');
```

---

## Connecting to the Database

### From Lambda Functions

Lambda functions use the db-layer which automatically:
1. Reads `DB_SECRET_NAME` from environment
2. Fetches credentials from Secrets Manager (cached)
3. Creates a connection pool with SSL

### From Local Development

Set environment variables in `.env` or shell:
```bash
export DB_HOST=localhost
export DB_PORT=5432
export DB_NAME=barkbase
export DB_USER=postgres
export DB_PASSWORD=your_password
```

### Direct Connection (for migrations, etc.)

For direct database access during development, you'll need:
1. A bastion host or VPN in the public subnet
2. Or use RDS Proxy with IAM authentication (future enhancement)
3. Or tunnel through AWS Session Manager

---

## Cost Estimates (Dev Environment)

| Resource | Estimated Monthly Cost |
|----------|------------------------|
| VPC + NAT Gateway | ~$35-45 |
| RDS db.t3.micro | ~$15-20 |
| Secrets Manager | ~$0.40 |
| CloudWatch Logs | ~$1-5 |
| Lambda Layer | Free (storage only) |
| **Total** | **~$50-70/month** |

*Costs vary by region and usage patterns.*

---

## Future Phases

### Phase 3: Identity & API Gateway
- Cognito User Pool
- API Gateway HTTP API
- Lambda authorizer

### Phase 4: Lambda Services
- Properties Service (v2)
- Entity Service
- Operations Service
- Analytics Service

### Phase 5: Frontend & Jobs
- S3 + CloudFront
- EventBridge scheduled jobs

---

## Troubleshooting

### CDK Bootstrap Failed
```bash
cdk bootstrap aws://ACCOUNT_ID/REGION --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess
```

### Stack Deployment Failed
1. Check CloudFormation console for detailed error
2. Review CloudWatch Logs for resource creation issues
3. Ensure IAM permissions are sufficient

### Cannot Connect to Database
1. Verify security group rules
2. Check that Lambda is in VPC with correct subnets
3. Verify credentials from Secrets Manager
4. Check that `DB_SECRET_NAME` is set correctly

### db-layer Not Working
1. Verify layer is attached to Lambda function
2. Check `DB_SECRET_NAME` environment variable
3. Verify Lambda has IAM permissions to read Secrets Manager
4. Check CloudWatch Logs for `[DB-LAYER]` prefixed messages

---

## Files Reference

```
aws/
├── cdk/
│   ├── bin/
│   │   └── barkbase.ts              # CDK app entry point
│   ├── lib/
│   │   ├── shared/
│   │   │   ├── ServiceStackProps.ts # Shared interfaces & helpers
│   │   │   └── DbLayer.ts           # DbLayer construct
│   │   ├── NetworkStack.ts          # VPC, subnets, security groups
│   │   ├── DatabaseStack.ts         # RDS PostgreSQL
│   │   └── SharedResourcesStack.ts  # Lambda layers
│   ├── cdk.json                     # CDK configuration
│   ├── package.json                 # Dependencies
│   └── tsconfig.json                # TypeScript config
│
└── layers/
    └── db-layer/
        └── nodejs/
            ├── package.json         # Layer dependencies (pg, @aws-sdk)
            └── db.js                # Database connection module

backend/
└── src/
    └── lib/
        └── db/
            └── index.js             # DB adapter (uses db-layer)
```
